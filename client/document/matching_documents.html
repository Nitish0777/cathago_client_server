<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matching Documents</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      .matches {
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
      h2 {
        text-align: center;
        color: #333;
      }
      .loading-indicator {
        display: none;
        color: #666;
        font-style: italic;
        margin: 20px;
      }
      .error-message {
        color: #dc3545;
        margin: 20px;
      }
      .back-button {
        margin: 20px;
        padding: 8px 16px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
      }
      .back-button:hover {
        background-color: #e9ecef;
      }
      .match-card {
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .match-card h3 {
        margin: 0 0 10px;
        font-size: 18px;
        color: #007bff;
      }
      .match-card p {
        margin: 5px 0;
        color: #555;
      }
      .match-card a {
        display: inline-block;
        margin-top: 10px;
        padding: 8px 12px;
        background-color: #007bff;
        color: #fff;
        text-decoration: none;
        border-radius: 4px;
      }
      .match-card a:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <button class="back-button" onclick="navigateBack()">
      Back to Documents
    </button>
    <div class="matches">
      <h2>Matching Documents</h2>
      <div class="loading-indicator">Loading matches...</div>
      <div class="error-message"></div>
      <div class="match-list"></div>
    </div>

    <script>
      // Global state management
      const state = {
        isLoading: false,
        authCheckPerformed: false,
        redirectInProgress: false,
      };

      // DOM elements
      const elements = {
        loader: null,
        errorDiv: null,
        matchList: null,
      };

      // Component for navigation
      const navigation = {
        navigateToLogin() {
          if (state.redirectInProgress) return; // Prevent multiple redirects
          state.redirectInProgress = true;
          console.log("Navigating to login page...");
          localStorage.removeItem("token");
          window.location.href = "../login/login.html";
        },

        navigateToIndex() {
          if (state.redirectInProgress) return; // Prevent multiple redirects
          state.redirectInProgress = true;
          console.log("Navigating to index page...");
          window.location.href = "index.html";
        },
      };

      // Component for authentication
      const auth = {
        checkAuth() {
          try {
            console.log("Checking authentication...");
            if (state.authCheckPerformed) {
              console.log("Auth check already performed, skipping");
              return localStorage.getItem("token");
            }

            state.authCheckPerformed = true;
            const token = localStorage.getItem("token");

            if (!token) {
              console.log("No token found, redirecting to login...");
              navigation.navigateToLogin();
              return false;
            }

            console.log("Token found");
            return token;
          } catch (error) {
            console.error("Authentication check error:", error);
            ui.showError("Error checking authentication status.");
            return false;
          }
        },
      };

      // Component for UI operations
      const ui = {
        initialize() {
          elements.loader = document.querySelector(".loading-indicator");
          elements.errorDiv = document.querySelector(".error-message");
          elements.matchList = document.querySelector(".match-list");
        },

        showLoading() {
          if (!elements.loader) return;
          elements.loader.style.display = "block";
          state.isLoading = true;
        },

        hideLoading() {
          if (!elements.loader) return;
          elements.loader.style.display = "none";
          state.isLoading = false;
        },

        showError(message) {
          if (!elements.errorDiv) return;
          elements.errorDiv.textContent = message;
        },

        clearError() {
          if (!elements.errorDiv) return;
          elements.errorDiv.textContent = "";
        },

        clearMatchList() {
          if (!elements.matchList) return;
          elements.matchList.innerHTML = "";
        },

        renderMatchCard(match) {
          try {
            return `
              <div class="match-card">
                <h3>${match.filename || "Unnamed Document"}</h3>
                ${
                  match.similarity !== undefined
                    ? `<p><strong>Similarity:</strong> ${(
                        match.similarity * 100
                      ).toFixed(2)}%</p>`
                    : ""
                }
                ${
                  match.created_at
                    ? `<p><strong>Created At:</strong> ${new Date(
                        match.created_at
                      ).toLocaleString()}</p>`
                    : ""
                }
                ${
                  match.content
                    ? `<p><strong>Content:</strong> <pre>${match.content}</pre></p>`
                    : ""
                }
                <a href="http://localhost:3000/${
                  match.filePath || match.filepath
                }" 
                   download="${match.filename || "document"}">
                  Download
                </a>
              </div>
            `;
          } catch (error) {
            console.error("Error rendering match card:", error);
            return `<div class="match-card"><p>Error displaying this match.</p></div>`;
          }
        },

        renderMatches(matches) {
          if (!elements.matchList) return;

          if (matches.length) {
            const matchCards = matches
              .map((match) => ui.renderMatchCard(match))
              .join("");
            elements.matchList.innerHTML = matchCards;
          } else {
            elements.matchList.innerHTML =
              "<p>No matching documents found.</p>";
          }
        },
      };

      // Component for data fetching
      const dataService = {
        async fetchMatches(docId, token) {
          try {
            const response = await fetch(
              `http://localhost:3000/document/matches/${docId}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );

            if (!response.ok) {
              if (response.status === 401) {
                console.log("Unauthorized, redirecting to login...");
                navigation.navigateToLogin();
                throw new Error("Unauthorized");
              }
              throw new Error(`HTTP error! Status: ${response.status}`);
            }

            return await response.json();
          } catch (error) {
            console.error("Fetch error:", error);
            throw error;
          }
        },
      };

      // Component for document matching logic
      const documentMatcher = {
        async loadMatches(token) {
          try {
            console.log("Loading matches...");
            const urlParams = new URLSearchParams(window.location.search);
            const docId = urlParams.get("docId");

            if (!docId) {
              console.log("Invalid document ID");
              ui.showError("Invalid document ID");
              return;
            }

            console.log("Document ID:", docId);
            ui.showLoading();
            ui.clearMatchList();
            ui.clearError();

            // Use the data service to fetch the data
            const data = await dataService.fetchMatches(docId, token);

            console.log("Data received:", data);
            const matches = data.similarDocuments || data.matches || [];
            ui.renderMatches(matches);
          } catch (error) {
            console.error("Error in loadMatches:", error);

            if (error.message !== "Unauthorized") {
              ui.showError(`Error loading matches: ${error.message}`);
            }
          } finally {
            ui.hideLoading();
          }
        },
      };

      // Global navigation function (for the back button onclick)
      function navigateBack() {
        navigation.navigateToIndex();
      }

      // Initialize the page safely
      function initializePage() {
        try {
          ui.initialize();
          const token = auth.checkAuth();
          if (token) {
            documentMatcher.loadMatches(token);
          }
        } catch (error) {
          console.error("Error initializing page:", error);
          ui.showError("Error initializing page.");
        }
      }

      // Wait for DOM to be fully loaded before initializing
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializePage);
      } else {
        initializePage();
      }
    </script>
  </body>
</html>
