<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="style.css" />

  </head>
  <body>
    <h1>Welcome to the Admin Dashboard</h1>
    <div
      class="credit-requests"
      id="credit-requests-section"
      style="display: none"
    >
      <h2>Credit Requests</h2>
      <table id="credit-requests-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Requested Credits</th>
            <th>Status</th>
            <th>Timestamp</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="credit-requests-list"></tbody>
      </table>
    </div>
    <div class="users-list">
      <h2>All Users</h2>
      <table id="users-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Credits</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="users-list"></tbody>
      </table>
    </div>
    <div class="analytics">
      <h2>Analytics</h2>
      <div class="analytics-card">
        <h3>Total Scans</h3>
        <p id="total-scans"></p>
      </div>
      <div class="analytics-card">
        <h3>Most Common Topics</h3>
        <p id="most-common-topics"></p>
      </div>
      <div class="analytics-card">
        <h3>Top Users</h3>
        <ul id="top-users"></ul>
      </div>
      <div class="analytics-card">
        <h3>Credit Usage</h3>
        <ul id="credit-usage"></ul>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");

        if (!token) {
          window.location.href = "../login/login.html";
          return;
        }

        if (role !== "admin") {
          window.location.href = "../dashboard/dashboard.html";
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:3000/admin/credit-requests",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          const data = await response.json();

          const creditRequestsList = document.getElementById(
            "credit-requests-list"
          );
          if (data.creditRequests.length > 0) {
            document.getElementById("credit-requests-section").style.display =
              "block";
            creditRequestsList.innerHTML = "";
            data.creditRequests.forEach((req) => {
              const row = document.createElement("tr");
              row.innerHTML = `
              <td>${req.id}</td>
              <td>${req.username}</td>
              <td>${req.credits_requested}</td>
              <td>${req.status}</td>
              <td>${req.timestamp}</td>
              <td>
                <button class="approve-btn" data-id="${req.user_id}">Approve</button>
                <button class="deny-btn" data-id="${req.user_id}">Deny</button>
              </td>
            `;
              creditRequestsList.appendChild(row);
            });

            document.querySelectorAll(".approve-btn").forEach((button) => {
              button.addEventListener("click", async (event) => {
                const userId = event.target.getAttribute("data-id");
                await handleRequest(userId, "approve");
              });
            });

            document.querySelectorAll(".deny-btn").forEach((button) => {
              button.addEventListener("click", async (event) => {
                const userId = event.target.getAttribute("data-id");
                await handleRequest(userId, "deny");
              });
            });

            async function handleRequest(userId, action) {
              try {
                await fetch(
                  `http://localhost:3000/admin/credits/handleRequest`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ userId, action }),
                  }
                );
                window.location.reload();
              } catch (error) {
                console.error("Error handling request:", error);
              }
            }
          }

          // Fetch and display all users
          const usersResponse = await fetch(
            "http://localhost:3000/admin/users",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          const usersData = await usersResponse.json();

          const usersList = document.getElementById("users-list");
          usersList.innerHTML = "";
          usersData.users.forEach((user) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.credits}</td>
            <td>
              <button class="delete-btn" data-id="${user.id}">Delete</button>
            </td>
          `;
            usersList.appendChild(row);
          });

          document.querySelectorAll(".delete-btn").forEach((button) => {
            button.addEventListener("click", async (event) => {
              const userId = event.target.getAttribute("data-id");
              await deleteUser(userId);
            });
          });

          async function deleteUser(userId) {
            try {
              await fetch(`http://localhost:3000/admin/delete/${userId}`, {
                method: "DELETE",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              });
              window.location.reload();
            } catch (error) {
              console.error("Error deleting user:", error);
            }
          }

          // Fetch and display analytics data
          const analyticsResponse = await fetch(
            "http://localhost:3000/admin/analytics",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          const analyticsData = await analyticsResponse.json();

          document.getElementById("total-scans").textContent =
            analyticsData.analytics.total_scans;
          document.getElementById("most-common-topics").textContent =
            analyticsData.analytics.most_common_topics;

          const topUsersList = document.getElementById("top-users");
          topUsersList.innerHTML = analyticsData.analytics.top_users
            .map(
              (user) =>
                `<li>User ID: ${user.user_id}, Total Scans: ${user.total_scans}</li>`
            )
            .join("");

          const creditUsageList = document.getElementById("credit-usage");
          creditUsageList.innerHTML = analyticsData.analytics.credit_usage
            .map(
              (user) =>
                `<li>Username: ${user.username}, Credits: ${user.credits}</li>`
            )
            .join("");
        } catch (error) {
          console.error("Error fetching data:", error);
        }
      });
    </script>
  </body>
</html>
